<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard EERR v2</title>
  <style>
    :root{--bg:#0f1115;--fg:#e7eaf0;--muted:#b7c2d0;--card:#171a22;--row:#1e222b;--blue:#1F4E78;--pos:#0bbf6a;--neg:#f05b5b}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{display:flex;flex-direction:column;height:100%}
    header{padding:12px 16px;background:var(--blue);color:#fff}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    select,.pill{background:#0f1824;color:#fff;border:1px solid #2a4669;border-radius:8px;padding:6px 10px}
    .content{display:grid;grid-template-columns:300px 1fr;gap:12px;flex:1;min-height:0;padding:12px}
    .card{background:var(--card);border:1px solid #2a2e3a;border-radius:10px;min-height:0}
    .side{padding:10px}
    .list{max-height:calc(100vh - 240px);overflow:auto;border-top:1px solid #2a2e3a}
    .list button{display:block;width:100%;text-align:left;padding:8px 10px;border:0;background:transparent;color:var(--fg);border-bottom:1px solid #222831;cursor:pointer}
    .list button.active{background:#1d2330}
    .table{display:flex;flex-direction:column;min-height:0}
    .thead,.row{display:grid;align-items:center}
    .thead{position:sticky;top:0;background:#141821;border-bottom:1px solid #2a2e3a}
    .row:nth-child(odd){background:var(--row)}
    .cell{padding:6px 8px;border-right:1px solid #242a35;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .cell.bold{font-weight:700}
    .cell.indent-1{padding-left:20px}
    .cell.indent-2{padding-left:40px}
    .cell.indent-3{padding-left:60px}
    .pos{color:var(--pos)} .neg{color:var(--neg)}
    .kpis{display:flex;gap:12px;flex-wrap:wrap;padding:10px}
    .kpi{background:#12161e;border:1px solid #2a2e3a;border-radius:8px;padding:10px 12px}
    .btn{background:#0f1824;color:#fff;border:1px solid #2a4669;border-radius:8px;padding:6px 10px;cursor:pointer}
  </style>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<script src="data.js"></script>
<div class="wrap">
  <header>
    <h1>Dashboard EERR v2</h1>
    <div class="toolbar">
      <label>Hoja: <select id="sheet"></select></label>
      <label>Año: <select id="year"></select></label>
      <button id="btn-export" class="btn">Exportar vista (XLSX)</button>
      <button id="btn-toggle-levels" class="btn">Colapsar niveles</button>
    </div>
  </header>
  <div class="content">
    <div class="card side">
      <h3>Grupos</h3>
      <div id="groups" class="list"></div>
    </div>
    <div class="card table">
      <div id="kpis" class="kpis"></div>
      <div id="thead" class="thead"></div>
      <div id="tbody" style="overflow:auto;min-height:0;flex:1"></div>
    </div>
  </div>
</div>
<script>
(async function(){
  // Cargar datos desde data.js (variable global) para poder abrir via file:// o GitHub Pages sin CORS
  // Si no existe la variable, intentar fetch como respaldo
  let data = window.DASHBOARD_DATA;
  if(!data){
    try { data = await (await fetch('data.json?ts='+Date.now())).json(); }
    catch(e){ alert('No se pudo cargar data.json. Asegure incluir data.js'); return; }
  }
  const $sheet=document.getElementById('sheet'), $year=document.getElementById('year');
  const $groups=document.getElementById('groups');
  const $thead=document.getElementById('thead'), $tbody=document.getElementById('tbody'), $kpis=document.getElementById('kpis');
  const $btnExport=document.getElementById('btn-export');
  const $btnToggle=document.getElementById('btn-toggle-levels');

  const years = data.years; // ej [2024,2025]
  years.forEach(y=>{const o=document.createElement('option');o.value=y;o.textContent=y;$year.appendChild(o)});
  $year.value = String(years[years.length-1]);

  const sheetNames = Object.keys(data.sheets);
  for(const s of sheetNames){const o=document.createElement('option');o.value=s;o.textContent=s;$sheet.appendChild(o)}
  $sheet.value = 'EERR';


  function fmtMoney(n){ if(n==null||n==='') return ''; const x=Number(n); if(!isFinite(x)) return ''; const s=x<0?'-':''; return s+'$ '+Math.abs(x).toLocaleString('es-CL', {minimumFractionDigits:2, maximumFractionDigits:2}); }

  function render(){
    const sheet = $sheet.value;
    const yy = String($year.value);
    const groups = data.sheets[sheet].groups;

    // construir header con meses de ese año
    const labels = data.labels_by_year[yy];
    $thead.innerHTML='';
    $thead.style.gridTemplateColumns = `minmax(260px, 1fr) repeat(${labels.length}, 140px)`;
    const h0=document.createElement('div'); h0.className='cell bold'; h0.textContent='Cuenta'; $thead.appendChild(h0);
    labels.forEach(l=>{const d=document.createElement('div'); d.className='cell bold'; d.textContent = `${l} ${yy}`; $thead.appendChild(d)});

    // lista de grupos
    $groups.innerHTML='';
    const buttons=[];
    for(const g of groups){const b=document.createElement('button');b.textContent=g.name; b.onclick=()=>sel(g); $groups.appendChild(b); buttons.push(b)}

    function sel(g){
      buttons.forEach(b=>b.classList.remove('active')); const idx=groups.indexOf(g); if(idx>=0) buttons[idx].classList.add('active');
      render.currentGroup = g.name; // guardar nombre del grupo seleccionado para exportación
      draw(g.rows);
    }

    function draw(rows){
      // KPIs: mostrar 4 líneas clave (YTD no se usa, solo último mes)
      const nameToRow = new Map(rows.map(r=>[r.Cuenta,r]));
      function lastMonthVal(rowName){ const r=nameToRow.get(rowName); if(!r) return ''; const arr=r.values_by_year[yy]||[]; return arr.length?arr[arr.length-1]:''; }
      $kpis.innerHTML='';
      [['Ingresos','Ingresos De Explotación'],['Margen','Total Margen De Explotación'],['Res. Operacional','Total Resultado Operacional'],['Utilidad','Utilidad']]
        .forEach(([lab,row])=>{const v=lastMonthVal(row); const div=document.createElement('div');div.className='kpi';div.innerHTML=`<div style='color:var(--muted)'>${lab} (últ. mes)</div><div style='font-size:18px'>${fmtMoney(v)}</div>`;$kpis.appendChild(div)});

      // Body
      $tbody.innerHTML='';
      rows.forEach(r=>{
        const row=document.createElement('div'); row.className='row';
        row.dataset.level = r.level || 0;
        row.style.gridTemplateColumns = $thead.style.gridTemplateColumns;
        const name=document.createElement('div'); name.className='cell '+(r.bold?'bold':'')+(r.level?(' indent-'+r.level):''); name.textContent=r.Cuenta; row.appendChild(name);
        const vals=r.values_by_year[yy]||[];
        labels.forEach((_,i)=>{const v=vals[i]; const d=document.createElement('div'); d.className='cell'; d.textContent=fmtMoney(v); if(typeof v==='number') d.classList.add(v<0?'neg':'pos'); row.appendChild(d)});
        $tbody.appendChild(row);
      });
    }

    // seleccionar primer grupo por defecto
    const gsel = groups[0];
    if(gsel) sel(gsel);
  }

  $sheet.onchange=render;
  $year.onchange=render;
  $btnToggle.onclick=()=>{
    const collapsed = $btnToggle.dataset.collapsed === '1';
    $btnToggle.dataset.collapsed = collapsed ? '0' : '1';
    $btnToggle.textContent = collapsed ? 'Colapsar niveles' : 'Expandir niveles';
    // Oculta niveles > 1 cuando está colapsado
    const rows = $tbody.querySelectorAll('.row');
    rows.forEach(r=>{
      const lvl = +(r.dataset.level||0);
      r.style.display = (!collapsed && lvl>0) ? 'none' : '';
    });
  };
  $btnExport.onclick=()=>{
    // Exporta a XLSX la vista actual (sheet/año/grupo seleccionado)
    const header = [...$thead.children].map(c=>c.textContent);
    const rows = [];
    rows.push(header);
    [...$tbody.children].forEach(r=>{
      if(r.style.display==='none') return; // respetar colapsado
      rows.push([...r.children].map(c=>c.textContent));
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    // Anchos de columnas
    ws['!cols'] = header.map((h,i)=>({wch: i===0?40:14}));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'EERR');
    // Nombre de archivo con hoja, año, grupo y timestamp
    const grp = (render.currentGroup || 'Global').replace(/[^\p{L}\p{N} _-]/gu,'').replace(/\s+/g,'_');
    const ts = new Date();
    const tsStr = `${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}_${String(ts.getHours()).padStart(2,'0')}${String(ts.getMinutes()).padStart(2,'0')}`;
    const fname = `EERR_${$sheet.value}_${$year.value}_${grp}_${tsStr}.xlsx`;
    XLSX.writeFile(wb, fname);
  };
  render();
})();
</script>
</body>
</html>

